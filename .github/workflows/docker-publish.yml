name: ğŸ³ Docker Build and Push to GHCR

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ› ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: ğŸ”‘ Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          # å¿…é¡»ä½¿ç”¨ GITHUB_TOKEN ä½œä¸ºå¯†ç 
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸš€ Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          # é»˜è®¤ä½¿ç”¨ä»“åº“æ ¹ç›®å½•ä½œä¸ºä¸Šä¸‹æ–‡
          context: .
          # è®¾ä¸º trueï¼Œæ„å»ºæˆåŠŸåè‡ªåŠ¨æ¨é€åˆ°å·²ç™»å½•çš„ registry
          push: true
          # -------------------------------------------------------------
          # æ ‡ç­¾å®šä¹‰ï¼šç›´æ¥ä½¿ç”¨ owner å’Œ repository name å˜é‡ã€‚
          # è­¦å‘Šï¼šè¯·ç¡®ä¿æ‚¨çš„ GitHub ä»“åº“åç§°å·²ç»æ˜¯å°å†™çš„ï¼Œ
          # å¦åˆ™åœ¨æ¨é€æ—¶å¯èƒ½ä¼šè¢« GHCR æ‹’ç»ã€‚
          # -------------------------------------------------------------
          tags: |
            ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:latest
            ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:${{ github.sha }}
          # ä½¿ç”¨ç¼“å­˜ï¼ŒåŠ é€Ÿåç»­æ„å»º
          cache-from: type=gha
          cache-to: type=gha,mode=max
          
      - name: âœ¨ Show Image Tags
        run: |
          echo "Successfully pushed images to GHCR:"
          echo "ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:latest"
          echo "ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:${{ github.sha }}"
