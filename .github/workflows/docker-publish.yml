name: ğŸ³ Docker Build and Push to GHCR

# è§¦å‘æ¡ä»¶: å½“ä»£ç æ¨é€åˆ° 'main' æˆ– 'master' åˆ†æ”¯æ—¶è§¦å‘
on:
  push:
    branches:
      - main
      - master
  # ä¹Ÿå¯ä»¥æ‰‹åŠ¨è§¦å‘ï¼Œæ–¹ä¾¿æµ‹è¯•
  workflow_dispatch:

# å®šä¹‰ç¯å¢ƒå˜é‡ (å¯é€‰ï¼Œä½†æ¨è)
env:
  # é•œåƒåç§°ï¼Œä½¿ç”¨ä»“åº“åçš„å°å†™å½¢å¼
  IMAGE_NAME: ${{ github.repository | toLower }}
  # æ„å»ºä¸Šä¸‹æ–‡è·¯å¾„ï¼Œé€šå¸¸æ˜¯ä»“åº“æ ¹ç›®å½•
  BUILD_CONTEXT: .

jobs:
  build-and-push:
    # åœ¨æœ€æ–°çš„ Ubuntu è¿è¡Œå™¨ä¸Šæ‰§è¡Œ
    runs-on: ubuntu-latest
    
    # æ­¥éª¤åˆ—è¡¨
    steps:
      - name: â¬‡ï¸ Checkout Repository
        # æ£€å‡ºä»£ç åˆ°è¿è¡Œå™¨
        uses: actions/checkout@v4
        
      - name: ğŸ› ï¸ Set up Docker Buildx
        # è®¾ç½® Buildxï¼Œå¯ç”¨é«˜çº§æ„å»ºåŠŸèƒ½
        uses: docker/setup-buildx-action@v3
        
      - name: ğŸ”‘ Log in to GitHub Container Registry
        # ç™»å½•åˆ° ghcr.io (GitHub Container Registry)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          # ä½¿ç”¨ GitHub è‡ªåŠ¨ç”Ÿæˆçš„ Token è¿›è¡Œè®¤è¯
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸš€ Build and Push Docker Image
        # æ ¸å¿ƒæ­¥éª¤ï¼šæ„å»ºå¹¶æ¨é€åˆ° GHCR
        uses: docker/build-push-action@v5
        with:
          # å‘Šè¯‰ action åœ¨å“ªé‡Œæ‰¾åˆ°è¦æ„å»ºçš„æ–‡ä»¶ (å³ä»“åº“æ ¹ç›®å½•)
          context: ${{ env.BUILD_CONTEXT }}
          # Dockerfile è·¯å¾„ï¼Œé»˜è®¤ä¸º BUILD_CONTEXT/Dockerfile
          # file: ${{ env.BUILD_CONTEXT }}/Dockerfile 
          # è®¾ä¸º trueï¼Œæ„å»ºæˆåŠŸåè‡ªåŠ¨æ¨é€åˆ°å·²ç™»å½•çš„ registry
          push: true
          # å®šä¹‰é•œåƒæ ‡ç­¾
          tags: |
            ghcr.io/${{ env.IMAGE_NAME }}:latest
            ghcr.io/${{ env.IMAGE_NAME }}:${{ github.sha }} # ä½¿ç”¨ commit SHA ä½œä¸ºç‰ˆæœ¬æ ‡ç­¾
          # ä½¿ç”¨ç¼“å­˜ï¼ŒåŠ é€Ÿåç»­æ„å»º
          cache-from: type=gha
          cache-to: type=gha,mode=max
          
      - name: âœ¨ Show Image Tags
        run: |
          echo "Successfully pushed images to GHCR:"
          echo "ghcr.io/${{ env.IMAGE_NAME }}:latest"
          echo "ghcr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}"
