name: ğŸ³ Docker Build and Push to GHCR

# è§¦å‘æ¡ä»¶: å½“ä»£ç æ¨é€åˆ° 'main' æˆ– 'master' åˆ†æ”¯æ—¶è§¦å‘
on:
  push:
    branches:
      - main
      - master
  # ä¹Ÿå¯ä»¥æ‰‹åŠ¨è§¦å‘ï¼Œæ–¹ä¾¿æµ‹è¯•
  workflow_dispatch:

jobs:
  build-and-push:
    # åœ¨æœ€æ–°çš„ Ubuntu è¿è¡Œå™¨ä¸Šæ‰§è¡Œ
    runs-on: ubuntu-latest
    
    permissions:
      contents: read # å…è®¸è¯»å–ä»£ç 
      packages: write # å…è®¸å†™å…¥ GHCR Package
    # æ­¥éª¤åˆ—è¡¨
    steps:
      - name: â¬‡ï¸ Checkout Repository
        # æ£€å‡ºä»£ç åˆ°è¿è¡Œå™¨
        uses: actions/checkout@v4
        
      - name: ğŸ› ï¸ Set up Docker Buildx
        # è®¾ç½® Buildxï¼Œå¯ç”¨é«˜çº§æ„å»ºåŠŸèƒ½ï¼ˆå¦‚ç¼“å­˜å’Œå¤šå¹³å°ï¼‰
        uses: docker/setup-buildx-action@v3
        
      - name: ğŸ”‘ Log in to GitHub Container Registry (ghcr.io)
        # ç™»å½•åˆ° GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }} # ç™»å½•ç”¨æˆ·
          # å¿…é¡»ä½¿ç”¨ GitHub è‡ªåŠ¨ç”Ÿæˆçš„ Token è¿›è¡Œè®¤è¯
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: ğŸ”‘ Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: ğŸš€ Build and Push Docker Image
        # æ ¸å¿ƒæ­¥éª¤ï¼šæ„å»ºå¹¶æ¨é€åˆ° GHCR
        uses: docker/build-push-action@v5
        with:
          # æ„å»ºä¸Šä¸‹æ–‡ï¼šä»“åº“æ ¹ç›®å½•ï¼ˆDockerfile æ‰€åœ¨ä½ç½®ï¼‰
          context: .
          # è®¾ä¸º trueï¼Œæ„å»ºæˆåŠŸåè‡ªåŠ¨æ¨é€åˆ°å·²ç™»å½•çš„ registry
          push: true
          # å®šä¹‰é•œåƒæ ‡ç­¾
          # æ ¼å¼ä¸º ghcr.io/OWNER/REPOSITORY:TAG
          # æ³¨æ„ï¼šè™½ç„¶æˆ‘ä»¬åœ¨ tags ä¸­ä½¿ç”¨äº†è¿™äº›å˜é‡ï¼Œ
          # ä½†ä¸ºä¿é™©èµ·è§ï¼Œè¯·ç¡®ä¿æ‚¨çš„ GitHub ä»“åº“åç§°å·²ç»æ˜¯å°å†™ã€‚
          tags: |
            ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:latest
            ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:${{ github.sha }}
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}:${{ github.sha }}
          # ä½¿ç”¨ GitHub Actions ç¼“å­˜æ¥åŠ é€Ÿåç»­æ„å»º
          cache-from: type=gha
          cache-to: type=gha,mode=max
          
      - name: âœ¨ Show Image Tags
        run: |
          echo "Successfully pushed images to GHCR:"
          echo "ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:latest"
          echo "ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:${{ github.sha }}"
